---
## 1.

<img width="968" height="517" alt="image" src="https://github.com/user-attachments/assets/144e481a-9b8c-4109-952f-948f78a1add2" />

---
##2.

<img width="1155" height="525" alt="image" src="https://github.com/user-attachments/assets/02ef6ecf-a38c-442d-b50e-3892ab1a2531" />

<img width="1155" height="520" alt="image" src="https://github.com/user-attachments/assets/14a4a4fb-98b8-4cad-a165-06abd774b7c8" />

<img width="1147" height="511" alt="image" src="https://github.com/user-attachments/assets/b4b88e9b-599e-4c9d-8a2a-6f858ef37b9b" />

---
# Jetson Orin Nano + USB 캠 기반 A4 정사영(mm) 측정 프로젝트 가이드
---

## 1) 환경 사양(레퍼런스)

- **보드/OS**: Jetson Orin Nano, Ubuntu **20.04.6 (focal)**, 커널 `5.10.104-tegra`
- **Python**: 3.8.10
- **OpenCV**: 4.5.4 (GStreamer 빌드 포함)
- **카메라**: USB UVC `/dev/video0`
  - 포맷 예시: **MJPG**, **YUYV**  
  - 확인: `v4l2-ctl --list-formats-ext -d /dev/video0`

---

## 2) 프로젝트 디렉토리 & 권한

```bash
mkdir -p ~/emb_project/project_A_distance/{src,data/{images,calib},docs,scripts,tests,logs}
# 홈 경로에서 root 소유 방지
sudo chown -R $USER:$USER ~/emb_project
chmod -R u+rwX,go-rwx ~/emb_project
```

> **주의:** 홈 아래에서 `sudo nano` 등으로 파일을 만들면 소유자가 root가 됩니다. 위처럼 소유권/권한을 사용자로 맞춰두세요.

---

## 3) 시스템 패키지 설치

```bash
sudo apt update
sudo apt install -y \
  python3-venv python3-pip \
  v4l-utils \
  gstreamer1.0-tools \
  gstreamer1.0-plugins-{base,good,bad,ugly} \
  libgstreamer1.0-dev libegl1-mesa
```

---

## 4) 파이썬 가상환경 & 필수 라이브러리

```bash
cd ~/emb_project/project_A_distance
python3 -m venv --system-site-packages .venv
source .venv/bin/activate
python -V                           # 3.8.10
python -c "import cv2; print(cv2.__version__)"  # 4.5.4

# pip 최신화 및 패키지
pip install --upgrade pip
pip install imutils
```

> **gpiozero/lgpio**는 GPIO 제어용으로 본 시각 프로젝트에는 **불필요**합니다.

---

## 5) 카메라 동작 확인

### 5.1 장치/포맷 조회
```bash
v4l2-ctl --list-devices
v4l2-ctl --list-formats-ext -d /dev/video0
```

### 5.2 스냅샷 1장 저장(헤드리스 OK)
```bash
python - <<'PY'
import cv2, os
os.makedirs("data/images", exist_ok=True)
cap = cv2.VideoCapture(0, cv2.CAP_V4L2)
cap.set(3,640); cap.set(4,480)
ok, f = cap.read()
print("grab ok:", ok, "| size:", None if not ok else f.shape)
if ok: cv2.imwrite("data/images/usb_snap.jpg", f)
cap.release()
PY
```

### 5.3 GStreamer로 스트림만 확인(화면 없이 FPS)
- **MJPG**:
```bash
gst-launch-1.0 v4l2src device=/dev/video0 ! \
  image/jpeg,width=640,height=480,framerate=30/1 ! \
  jpegdec ! videoconvert ! fpsdisplaysink video-sink=fakesink sync=false
```
- **YUYV**:
```bash
gst-launch-1.0 v4l2src device=/dev/video0 ! \
  video/x-raw,format=YUY2,width=640,height=480,framerate=30/1 ! \
  videoconvert ! fpsdisplaysink video-sink=fakesink sync=false
```

> `not-negotiated` 오류는 캡스/디코더 미지정 문제일 때 발생 → 위와 같이 명시해 해결합니다.

---

## 6) SSH 환경에서 화면 보기

### 6.1 헤드리스 모드(권장)
- `--display 0`으로 `cv2.imshow` 비활성화, 콘솔/파일 저장으로 확인.

### 6.2 Windows에서 X11 포워딩
1) **VcXsrv(XLaunch)** 실행  
   - Multiple windows / Display **0** / Start no client  
   - **Clipboard 체크**, **Native OpenGL 해제(-nowgl)**  
   - (필요 시 테스트용 **-ac**)
2) PowerShell에서 Jetson 접속
```powershell
ssh -Y kyoungmo@<JETSON_IP>
```
3) Jetson에서 확인
```bash
echo $DISPLAY   # 예: localhost:10.0
xeyes           # 창이 뜨면 OK
```

> `Authorization required` → VcXsrv를 일시 `-ac`로 실행하거나 X11 포워딩으로 재접속  
> `Cannot establish any listening sockets` → 기존 X 서버 종료 후 `:1`로 재시도

---

## 7) 실행 스크립트(what & how)

### 7.1 `scripts/run.sh`
- 초기 라이브 테스트(헤드리스)용: **`src/object_size_live.py`** 실행
- 콘솔에 측정 로그, 2초마다 이미지 저장

```bash
./scripts/run.sh
```

### 7.2 `scripts/run_warp.sh`
- **A4 정사영 + mm 평면** 창: **`src/a4_warp_live.py`**

```bash
./scripts/run_warp.sh
# --px-per-mm : 워프 해상도(1mm당 px). 1.0~2.0 권장
```

- 출력 창
  - `A4 view (original)`: 원본 + A4 윤곽
  - `A4 warped (mm-plane)`: 210×297(mm) 워프 + 10mm 그리드  
- 저장: `data/images/a4_view_*.jpg`, `a4_warp_*.jpg`

### 7.3 `scripts/run_a4_object.sh`
- **A4 위 물체를 분리(Otsu)** 해서 **워프 화면**에 **치수(mm)** 라벨: **`src/a4_object_measure_live.py`**

```bash
./scripts/run_a4_object.sh
# --min-mm-area : 작은 잡음 제거(㎟)
# --single      : 가장 큰 물체만 측정
```

- 저장: `obj_view_*.jpg`, `obj_warp_*.jpg`

### 7.4 `scripts/run_a4_object_proj.sh`
- 워프에서 측정한 박스를 **원본 화면에도 역투영**(바운딩박스 라벨): **`src/a4_object_detect_live.py`**

```bash
./scripts/run_a4_object_proj.sh
# --white-s-max / --white-v-min : “거의 흰색(A4)” HSV 범위 조절
```

- 저장: `det_view_*.jpg`(원본), `det_warp_*.jpg`(워프)

> 모든 스크립트는 내부에서 프로젝트 루트/가상환경을 자동 인식하고 실행합니다.

---

## 8) 핵심 파이썬 파일(요약)

- **`src/object_size_live.py`**  
  - 헤드리스 친화, `--display`로 창 on/off.  
  - **A4 후보만** 골라 **짧은 변 210mm로 캘리브레이션 잠금**.  
  - 콘솔 `[MEASURE]`, 2초마다 프레임 저장.

- **`src/a4_warp_live.py`**  
  - **A4 사각 검출** → `warpPerspective`로 **정사영(1px≈1mm)** → **그리드** 표시.  
  - 워프 평면에서 컨투어 치수 표기.

- **`src/a4_object_measure_live.py`**  
  - 워프 평면에서 **비-흰색 영역 분리(Otsu)** → `minAreaRect`로 **가로×세로(mm)** 라벨.

- **`src/a4_object_detect_live.py`**  
  - 워프 화면 + **원본 화면에 역투영** 바운딩박스/라벨 표시.  
  - HSV로 “거의 흰색(A4)” 제거(`--white-s-max`, `--white-v-min` 튜닝).

공통 옵션:
- `--device {0|/dev/videoX}` / `--width` `--height`
- `--px-per-mm` : 워프 해상도(선명도) — 기본 1.5
- `--display {0|1}` : 창 표시 여부

---

## 9) 워크플로우(재현용)

1) 카메라 연결 → `/dev/video0` 확인 (`v4l2-ctl --list-devices`)
2) (옵션) 스냅샷 저장으로 동작 확인
3) X11 포워딩 쓸 경우 VcXsrv 실행 → `ssh -Y` → `xeyes`
4) **A4가 프레임에 모두 보이게** 배치(네 모서리)
5) 정사영 확인: `./scripts/run_warp.sh`
6) 물체 치수 측정
   - 워프 화면만: `./scripts/run_a4_object.sh`
   - **원본에도 바운딩박스**: `./scripts/run_a4_object_proj.sh`
7) 결과 이미지는 항상 `data/images/`에서 확인

---

## 10) 트러블슈팅

- **`cv2.imshow` GTK 에러(SSH)** → `--display 0`(헤드리스) 또는 X11 포워딩 설정.
- **X11 창 안 뜸**
  - VcXsrv 먼저 실행, 방화벽 허용
  - `ssh -Y` / `echo $DISPLAY`(예: `localhost:10.0`)
  - `Authorization required` → VcXsrv `-ac`로 테스트 후 보안 되돌리기
  - `Cannot establish any listening sockets` → 기존 X 서버 종료, `:1`로 실행
- **GStreamer `not-negotiated`** → 포맷 캡스 명시(MJPG `image/jpeg ! jpegdec`, YUYV `video/x-raw,format=YUY2`)
- **/dev/video0 없음** → 케이블/허브 확인, `dmesg | tail`, 권한: `sudo usermod -a -G video $USER && newgrp video`
- **A4 검출 불안**
  - A4 비율/면적 파라미터 조정: `RATIO_MIN/MAX`, `AREA_FRAC_MIN`, `MIN_CONTOUR`
  - A4를 프레임 30~60%로 크게, 조명 균일/배경 대비 ↑
- **물체 분리 불안**
  - HSV 흰색 범위 조절: `--white-s-max`, `--white-v-min`
  - 작은 물체면 `--min-mm-area`를 더 낮춤
- **정확도 향상**
  - 워프 해상도 ↑: `--px-per-mm 2.0`
  - 체커보드 **렌즈 왜곡 보정** 후 검출/워프 적용

---

## 11) 확장 아이디어

- **CSV 로그**(측정값+타임스탬프), **토글 키**(측정 고정/리셋)
- **특정 색상/태그**만 측정(예: 파란 물체만)
- **여러 물체 동시** 측정 결과 정렬/표
- **UDP 스트리밍**(Jetson→PC)로 저지연 원격 미리보기
- **옵션 프리셋**(예: `--preset closeup`, `--preset wide`)

---

## 부록: 자주 쓰는 명령 모음

```bash
# 가상환경
cd ~/emb_project/project_A_distance
source .venv/bin/activate

# 정사영 데모
./scripts/run_warp.sh

# A4 위 물체 치수(워프 화면)
./scripts/run_a4_object.sh

# A4 위 물체 치수 + 원본에도 박스 표시
./scripts/run_a4_object_proj.sh
```
