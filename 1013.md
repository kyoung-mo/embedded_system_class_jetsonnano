# Week 13–14: 프로젝트 C — DeepStream으로 공통 스트리밍 서버 영상에서 YOLO 추론

## 1. 목표
- **공통 스트리밍 서버(예: RTSP/H.264)**의 영상을 **Jetson Nano**에서 받아 DeepStream 파이프라인으로 처리  
- DeepStream 환경에서 **YOLO** 모델을 이용해 객체를 탐지하고 FPS, Latency, 자원 사용률을 측정  
- 이후 **YOLO 단독 실행(OpenCV 기반)** 결과와 성능 비교 그래프 작성

---

## 2. 준비물 및 환경
- Jetson Nano (JetPack + TensorRT + DeepStream 설치 완료)
- RTSP 스트리밍 서버 주소 (예: `rtsp://192.168.0.10:554/stream1`)
- YOLOv8n 모델 (또는 YOLOv5n)
  - ONNX 변환 및 TensorRT 엔진(`.engine`) 파일 준비 필요

---

## 3. 디렉토리 구조
```
projC_deepstream_yolo/
├─ models/
│  ├─ yolov8n.onnx
│  ├─ yolov8n_b1_fp16.engine
│  └─ labels.txt
├─ deepstream/
│  ├─ ds_rtsp_yolo.txt
│  └─ nvdsinfer_custom_impl_Yolo/
├─ metrics/
│  ├─ deepstream_perf.csv
│  └─ tegrastats.log
└─ scripts/
   ├─ export_onnx.sh
   ├─ build_engine.sh
   └─ run_deepstream.sh
```

---

## 4. 모델 변환 과정

### 4-1. YOLO → ONNX 변환
```bash
python - <<'PY'
from ultralytics import YOLO
m = YOLO('yolov8n.pt')
m.export(format='onnx', opset=12, dynamic=False, imgsz=640)
PY
mv yolov8n.onnx ./models/
```

### 4-2. ONNX → TensorRT 변환
```bash
trtexec   --onnx=./models/yolov8n.onnx   --saveEngine=./models/yolov8n_b1_fp16.engine   --explicitBatch   --minShapes=input:1x3x640x640   --optShapes=input:1x3x640x640   --maxShapes=input:1x3x640x640   --fp16 --workspace=2048
```

---

## 5. DeepStream 설정 (ds_rtsp_yolo.txt)
```ini
[application]
enable-perf-measurement=1
perf-measurement-interval-sec=5

[source0]
enable=1
type=4
uri=rtsp://192.168.0.10:554/stream1
num-sources=1
latency=0
drop-frame-interval=0

[streammux]
batch-size=1
width=1280
height=720
live-source=1

[primary-gie]
enable=1
gie-unique-id=1
model-engine-file=../models/yolov8n_b1_fp16.engine
labelfile-path=../models/labels.txt
network-mode=2
parse-bbox-func-name=NvDsInferParseCustomYolo
custom-lib-path=./nvdsinfer_custom_impl_Yolo/libnvdsinfer_custom_impl_Yolo.so

[sink0]
enable=1
type=3
sync=0
qos=0
```

---

## 6. 실행 스크립트
```bash
#!/bin/bash
cd "$(dirname "$0")/../deepstream"
deepstream-app -c ds_rtsp_yolo.txt | tee ../metrics/deepstream_perf.csv
```
자원 사용률 로그:
```bash
tegrastats --interval 1000 | tee metrics/tegrastats.log
```

---

## 7. 측정 및 시각화
- FPS, Latency, GPU/CPU 사용률 수집
- `deepstream_perf.csv`, `tegrastats.log` 파일을 이용해 Matplotlib으로 시각화
- YOLO 단독 실행(OpenCV) 결과와 비교

---

## 8. 과제 체크리스트
1. RTSP 스트림 정상 연결 확인  
2. YOLO 모델 → ONNX → TensorRT 변환  
3. DeepStream 설정 수정 및 실행  
4. FPS 및 Latency 확인  
5. 자원 사용률 로그 수집  
6. Matplotlib 그래프 작성  
7. 결과 분석 및 보고서 작성

---

## 9. 문제 해결 팁
- **지연 발생 시**: RTSP `latency=0` / 네트워크 대역폭 확인  
- **모델 매칭 오류**: 입력 해상도(640x640) 및 전처리 확인  
- **파서 문제**: YOLO 전용 `NvDsInferParseCustomYolo` 사용

---

## 10. 산출물
- DeepStream 실행 화면 (탐지 박스 + FPS)
- `deepstream_perf.csv`, `tegrastats.log`
- YOLO 단독 vs DeepStream 비교 그래프
- 성능 분석 및 해석 리포트
