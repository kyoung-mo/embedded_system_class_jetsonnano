# Jetson Nano 프로젝트 A_distance 정리

## 1. 목표
- 카메라 + OpenCV만으로 기준 객체를 이용해 픽셀↔cm 환산
- 거리 임계값 조건에 따라 LED/부저(GPIO) 제어
- 화면 오버레이(FPS, 거리 cm) 및 보드 동작 확인

---

## 2. 최종 디렉터리 구조
```
~/emb_project/A_distance
├─ venv/
├─ requirements.txt
├─ run.sh
└─ src/
   ├─ camera.py            # USB/CSI 입력, FPS 계산
   ├─ aruco_utils.py       # ArUco 검출/표시, 마커 픽셀 길이 추정
   ├─ distance.py          # 보정(px/cm) 및 거리 변환
   ├─ gpio_controller.py   # Jetson.GPIO 기반 LED/부저 제어
   └─ main.py              # 통합 루프, GUI/Headless 모드
```

---

## 3. 환경 세팅 요약
- Python: 3.8.10
- 가상환경 패키지 설치 문제 해결
  - `python3-venv` 미설치 오류 → 설치
    ```bash
    sudo apt update
    sudo apt install -y python3-venv
    ```
  - venv 생성 및 활성화
    ```bash
    cd ~/emb_project/A_distance
    python3 -m venv venv
    source venv/bin/activate
    pip install --upgrade pip
    ```
- 의존성
  - `requirements.txt` 최종
    ```
    opencv-python==4.8.1.78
    numpy>=1.24,<2.0
    imutils>=0.5.4
    Jetson.GPIO
    # 필요 시: opencv-contrib-python==4.8.1.78 (ArUco 모듈이 없을 때 대체 설치)
    ```
  - `lgpio` 빌드 실패 이슈로 `gpiozero/lgpio` 제거, Jetson.GPIO 사용으로 전환

---

## 4. GPIO 권한/규칙
- 그룹 및 규칙 설정
  ```bash
  sudo groupadd -f gpio
  sudo usermod -aG gpio $USER
  sudo udevadm control --reload-rules && sudo udevadm trigger
  newgrp gpio   # 현재 셸에 즉시 반영(한 번만)
  ```
- Jetson.GPIO udev 규칙 파일이 없는 경우 제공 경로에서 복사(환경에 따라 상이)
  ```bash
  sudo cp /usr/lib/python3/dist-packages/Jetson/GPIO/99-gpio.rules /etc/udev/rules.d/ 2>/dev/null || true
  ```

---

## 5. 카메라/디스플레이 모드
- SSH 환경에서 `cv2.imshow` 사용 시 Qt xcb 에러 발생 → Headless 모드로 실행하거나, Jetson에 모니터 연결 또는 X11 포워딩 사용
- USB 카메라: `/dev/video0` 확인
- CSI 카메라: GStreamer 파이프라인 사용

---

## 6. 실행 스크립트(run.sh)
현재 구성은 Headless + 테스트 거리 주입으로 GPIO 동작을 먼저 검증:
```bash
#!/usr/bin/env bash
set -e
cd "$(dirname "$0")"
source venv/bin/activate
export PYTHONPATH=src
python -u src/main.py --camera 0 --method aruco --marker-size 5.0 --threshold 40 --headless --headless-dist 30
```

### 변형 예시
- USB 카메라 + GUI:
  ```bash
  python -u src/main.py --camera 0 --method aruco --marker-size 5.0 --threshold 40
  ```
- CSI 카메라 파이프라인:
  ```bash
  PIPELINE="nvarguscamerasrc ! video/x-raw(memory:NVMM), width=1280, height=720, framerate=30/1, format=NV12 ! nvvidconv ! video/x-raw, format=BGRx ! videoconvert ! video/x-raw, format=BGR ! appsink drop=true sync=false"
  python -u src/main.py --pipeline "$PIPELINE" --method aruco --marker-size 5.0 --threshold 40 --headless --headless-dist 30
  ```

---

## 7. 소스 역할 요약
- `camera.py`: USB 인덱스 또는 GStreamer 파이프라인 입력, FPS 계산
- `aruco_utils.py`: ArUco 딕셔너리 로드, 마커 검출/표시, 변 길이(px) 평균 산출
- `distance.py`: 보정(px/cm) 계산, 두 점 사이 픽셀→cm 변환
- `gpio_controller.py`: `Jetson.GPIO`로 LED(BCM 27), 부저(BCM 18) 제어
- `main.py`: 인자 파싱, 보정/거리 계산, GPIO 토글, GUI/Headless 모드 분기

---

## 8. 현재 실행 플로우
1) `source venv/bin/activate`
2) `./run.sh` 실행  
   - Headless + `--headless-dist 30`로 GPIO 동작 확인
3) 실제 측정 시  
   - 모니터 연결 또는 X11 포워딩
   - `--headless` 제거 → 창에서 마우스 좌클릭으로 두 점 찍어 거리 확인
   - `r`: 재보정, `c`: 클릭 점 초기화, `q`: 종료

---

## 9. 하드웨어 배선(BCM 기준)
- LED: 27, Buzzer: 18, 공통 GND 필수
- 능동형 부저 권장(수동형은 음압 약할 수 있음)

---

## 10. 다음 단계 제안
- A4 보정 루틴 추가(사각형 검출로 px/cm 산출)
- 임계값/마커 크기 슬라이더 UI 추가(실시간 튜닝)
- 캘리브레이션 결과 저장/로드(JSON)
- 결과/로그 디렉터리 표준화: `~/emb_project/results/A/YYYYMMDD-HHMM/`
- README 정리(설치, 실행, 트러블슈팅, 핀맵)

---

# `run.sh` 동작과 연관 요소 정리

`run.sh`는 프로젝트 실행을 위한 얇은 런처 스크립트입니다. 가상환경을 활성화하고, 파이썬 모듈 경로를 설정한 뒤, 실제 로직이 담긴 `src/main.py`를 실행합니다. 실제 하드웨어 접근(카메라, GPIO)은 파이썬 코드에서 이루어집니다.

---

## 실행 순서
1. **가상환경 활성화**
   - `source venv/bin/activate`
   - `venv`에 설치된 `python`, `opencv-python`, `numpy`, `Jetson.GPIO` 등을 사용하게 합니다.

2. **모듈 경로 설정**
   - `export PYTHONPATH=src`
   - `src/` 폴더 안의 모듈(`camera.py`, `gpio_controller.py`, `distance.py`, `aruco_utils.py`)을 import 가능하게 합니다.

3. **메인 프로그램 실행**
   - 예시:  
     ```bash
     python -u src/main.py --camera 0 --method aruco --marker-size 5.0 --threshold 40 --headless --headless-dist 30
     ```
   - 여기서 실제 영상 처리와 GPIO 제어가 수행됩니다.

---

## `main.py`가 로드하는 파일/모듈
- `src/camera.py`  
  - USB 카메라: **`/dev/video0`** 등 V4L2 디바이스를 OpenCV로 엽니다.
  - CSI(MIPI) 카메라: **GStreamer 파이프라인**(예: `nvarguscamerasrc`)을 통해 NVIDIA Argus 경로를 사용합니다.
- `src/gpio_controller.py`  
  - **Jetson.GPIO** 라이브러리로 보드의 GPIO 핀을 제어합니다.  
  - 기본 핀: LED(BCM 27), 부저(BCM 18)
- `src/distance.py` + `src/aruco_utils.py`  
  - OpenCV(및 필요 시 ArUco 모듈)로 보정(px/cm), 두 점 거리(px) 계산, 시각화 보조를 담당합니다.

---

## 관련 하드웨어/OS 리소스
- **카메라**
  - USB 카메라: `/dev/videoN` (V4L2) 디바이스 파일
  - CSI(MIPI) 카메라: `nvarguscamerasrc` → NVMM 경로를 거쳐 OpenCV에 전달
- **GPIO**
  - Jetson 보드의 GPIO 컨트롤러
  - 사용자 계정이 `gpio` 그룹에 포함되어 있어야 무sudo 접근 가능 (udev 규칙 적용 필요)
- **디스플레이(선택 사항)**
  - GUI 모드(`cv2.imshow`)에서만 X 서버가 필요
  - Headless 모드에서는 디스플레이 없이 동작

---

## 실행 옵션과 영향
- `--camera 0`  
  USB 카메라 인덱스 사용. 장치가 없으면 오픈 실패.
- `--pipeline "<GStreamer 문자열>"`  
  CSI(MIPI) 카메라 사용 시 지정. 지정되면 `--camera`는 무시됩니다.
- `--method aruco`  
  ArUco 마커로 스케일 보정 수행.
- `--marker-size 5.0`  
  마커 한 변의 실제 길이(cm). 보정 정확도에 직결됩니다.
- `--threshold 40`  
  측정 거리(cm)가 임계값 이하일 때 LED/부저 ON.
- `--headless`  
  GUI 없이 동작. SSH 환경이나 모니터가 없을 때 사용.
- `--headless-dist 30`  
  헤드리스에서 실제 클릭이 불가하므로, 테스트용으로 거리(cm)를 주입해 GPIO 동작을 검증.

---

