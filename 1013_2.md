인터넷 거버

# Week 13–14: 프로젝트 C — 공개 RTSP 영상 기반 DeepStream + YOLO 성능 비교 (중간 정리)

## 1. 진행 개요
이번 주차에서는 Jetson Orin Nano에서 공개 RTSP 스트림 영상을 입력으로 받아  
YOLOv8 모델을 이용한 객체 탐지 성능을 실험하고, 이후 DeepStream 파이프라인으로 통합하여  
성능(FPS, Latency, 리소스 사용률) 비교 분석을 수행하는 것을 목표로 한다.

현재까지 Jetson 환경 구축 및 YOLO 모델 변환 단계를 완료하였으며,  
공개 RTSP 영상을 대상으로 YOLO(OpenCV 기반) 추론 테스트까지 진행하였다.

---

## 2. Jetson 환경 설정
- 보드: Jetson Orin Nano (JetPack 5.1.2, L4T R35.3.1)
- CUDA / TensorRT 버전:
  ```bash
  CUDA 11.4, TensorRT 8.5.2
  ```
- 확인 결과:
  ```bash
  $ nvcc --version         # nvcc 미설치 상태
  $ dpkg -l | grep -i tensorrt
  ```
  TensorRT 8.5.2 설치 확인  
  DeepStream은 아직 설치되지 않은 상태 (`deepstream-app: command not found`)

---

## 3. 프로젝트 디렉토리 구성
```bash
projC_deepstream_yolo/
├─ models/
│  └─ yolov8n.onnx
├─ metrics/
│  └─ yolo_opencv_perf.csv
└─ scripts/
   ├─ rtsp_yolo_live.py
   └─ ...
```

현재 YOLO 모델 변환 및 RTSP 테스트 중심으로 진행 중이며,  
DeepStream 관련 설정(`ds_rtsp_yolo.txt`)은 이후 단계에서 추가 예정이다.

---

## 4. 모델 변환 단계

### YOLOv8 → ONNX 변환
```bash
python - <<'PY'
from ultralytics import YOLO
m = YOLO("yolov8n.pt")
m.export(format="onnx", opset=12, imgsz=640)
PY
mv yolov8n.onnx ./models/
```

변환 완료: `models/yolov8n.onnx`  
입력/출력 노드 확인 결과:
```
Inputs: ['images']
Outputs: ['output0']
```

### TensorRT 변환 시도
```bash
trtexec --onnx=./models/yolov8n.onnx         --saveEngine=./models/yolov8n_b1_fp16.engine         --shapes=images:1x3x640x640         --fp16 --memPoolSize=workspace:2048
```

결과: “Static model does not take explicit shapes” 오류 발생  
→ 해결 예정: `--explicitBatch` 제거 또는 `dynamic=True`로 ONNX 재변환

ONNX → TensorRT 변환 오류 요약 (간단 정리)

1. 입력 이름 불일치
- 모델의 입력 이름은 `images` 인데  
  `--minShapes=input:1x3x640x640` 처럼 `input` 을 써서 에러 발생.  
  → `--shapes=images:1x3x640x640` 로 수정.

2. 정적 ONNX 모델에 shapes 지정
- `yolov8n.onnx` 은 이미 고정 크기(1×3×640×640) 모델이라  
  `--shapes` 옵션을 주면 “Static model…” 에러가 뜸.  
  → 해결책 두 가지 중 선택:
  - (a) `--shapes` 옵션 빼고 그대로 빌드  
  - (b) ONNX를 `dynamic=True`로 다시 export 후 `--shapes` 사용.

입력 이름 잘못 썼고, 정적 모델에 shape 옵션을 줘서 문제 생김


---

## 5. 공개 RTSP 스트림 테스트
라즈베리파이 없이 공개 RTSP 주소를 활용하여 YOLO 추론 테스트를 수행하였다.

| 테스트 스트림 | 주소 | 상태 |
|----------------|------|------|
| Big Buck Bunny | `rtsp://wowzaec2demo.streamlock.net/vod/mp4:BigBuckBunny_115k.mov` | 정상 연결 |
| IP Pattern Stream | `rtsp://rtsp.stream/pattern` | 간헐적 끊김 발생 |

---

## 6. YOLO 단독 RTSP 테스트 코드
`/scripts/rtsp_yolo_live.py`
```python
import cv2, time, argparse, csv
from ultralytics import YOLO

ap = argparse.ArgumentParser()
ap.add_argument("--rtsp", required=True, help="rtsp://IP:PORT/path")
ap.add_argument("--conf", type=float, default=0.5)
ap.add_argument("--log", default="../metrics/yolo_opencv_perf.csv")
args = ap.parse_args()

gst = (
    f"rtspsrc location={args.rtsp} latency=0 ! "
    "rtph264depay ! h264parse ! nvv4l2decoder ! "
    "nvvidconv ! video/x-raw,format=BGRx ! "
    "videoconvert ! video/x-raw,format=BGR ! appsink"
)
cap = cv2.VideoCapture(gst, cv2.CAP_GSTREAMER)
if not cap.isOpened():
    raise SystemExit("RTSP 열기 실패: URL 또는 GStreamer 플러그인 확인 필요.")

model = YOLO("yolov8n.pt")
t_prev = time.time(); ema_fps = 0.0
with open(args.log, "w", newline="") as f:
    w = csv.writer(f); w.writerow(["t", "fps", "lat_ms"])
    while True:
        ok, frame = cap.read()
        if not ok: break
        t0 = time.time()
        res = model.predict(frame, conf=args.conf, verbose=False)
        annotated = res[0].plot()
        t1 = time.time()
        inst_fps = 1.0 / max(t1 - t_prev, 1e-6)
        t_prev = t1
        ema_fps = 0.9 * ema_fps + 0.1 * inst_fps
        w.writerow([t1, ema_fps, (t1 - t0)*1000.0])
        cv2.putText(annotated, f"FPS:{ema_fps:.1f}", (8,28),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0,255,0), 2)
        cv2.imshow("RTSP + YOLO", annotated)
        if cv2.waitKey(1) & 0xFF == 27: break

cap.release()
cv2.destroyAllWindows()
```

---

## 7. 테스트 결과
- RTSP 연결 정상 확인 (`cap.isOpened() → True`)
- GStreamer 기반 영상 스트림 수신 성공
- YOLO 추론 영상 표시 및 FPS 측정 로그 기록 완료
- 일부 스트림에서 버퍼링 및 지연 발생 (네트워크 영향 추정)

---

## 8. 다음 단계 계획
1. TensorRT 변환 오류 해결 (`dynamic=True` 옵션 적용 예정)
2. DeepStream 구성 파일 작성 및 실행 (`ds_rtsp_yolo.txt`)
3. YOLO(OpenCV)와 DeepStream 환경의 성능 비교
4. FPS, Latency, GPU/CPU 사용률 수집 및 시각화

---

## 9. 중간 점검 요약

| 항목 | 상태 | 비고 |
|------|------|------|
| Jetson Orin 환경 세팅 | 완료 | TensorRT 설치 확인 |
| YOLOv8 → ONNX 변환 | 완료 | 입력/출력 노드 검증 완료 |
| ONNX → TensorRT 변환 | 오류 발생 | Static Shape 관련 |
| RTSP 영상 수신 | 성공 | 공개 스트림 정상 수신 |
| YOLO 단독 추론 | 완료 | FPS/Latency 측정 가능 |
| DeepStream 설정 | 준비 중 | 다음 단계 예정 |

---

## 10. 향후 산출물 예정
- deepstream_perf.csv, tegrastats.log
- YOLO vs DeepStream 성능 비교 그래프
- 성능 분석 및 결과 보고서
